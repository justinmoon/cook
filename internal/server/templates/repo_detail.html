{{template "base" .}}

{{define "content"}}
<h1>{{.Repo.Name}}</h1>

{{if .IsOwner}}
<div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
    <button onclick="document.getElementById('task-form').showModal()">+ New Task</button>
    <button class="secondary" onclick="document.getElementById('branch-form').showModal()">+ New Branch</button>
</div>

<dialog id="task-form">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('task-form').close()"></button>
            <h3>New Task</h3>
        </header>
        <form method="POST" action="/repos/{{.Repo.Owner}}/{{.Repo.Name}}/tasks">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <label>
                Title
                <input type="text" name="title" placeholder="Fix login bug" required autofocus>
            </label>
            <label>
                Description (optional)
                <textarea name="body" rows="3" placeholder="Describe the task..."></textarea>
            </label>
            {{if .TaskError}}<p style="color: var(--pico-del-color);">{{.TaskError}}</p>{{end}}
            <button type="submit">Create Task</button>
        </form>
    </article>
</dialog>

<dialog id="branch-form">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('branch-form').close()"></button>
            <h3>New Branch</h3>
        </header>
        <form method="POST" action="/repos/{{.Repo.Owner}}/{{.Repo.Name}}/branches">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <label>
                Branch Name
                <input type="text" name="name" placeholder="feature-name" required pattern="[a-zA-Z0-9_-]+" title="Letters, numbers, underscores, and hyphens only (no slashes)" autofocus>
            </label>
            <label>
                Link to Task (optional)
                <select name="task_slug">
                    <option value="">-- No task --</option>
                    {{range .Tasks}}
                    <option value="{{.Slug}}">{{.Slug}} - {{.Title}}</option>
                    {{end}}
                </select>
            </label>
            <label>
                Dotfiles (optional)
                <select name="dotfiles">
                    {{if .Dotfiles}}
                    {{range .Dotfiles}}
                    <option value="{{.URL}}">{{.Name}}</option>
                    {{end}}
                    <option value="">-- None --</option>
                    {{else}}
                    <option value="">-- None --</option>
                    {{end}}
                </select>
                <small><a href="/settings/dotfiles">Manage dotfiles</a></small>
            </label>
            {{if .BranchError}}<p style="color: var(--pico-del-color);">{{.BranchError}}</p>{{end}}
            <button type="submit">Create Branch</button>
        </form>
    </article>
</dialog>
{{end}}

<section>
<h2>Tasks</h2>
{{if .Tasks}}
<table>
    <thead>
        <tr>
            <th>Title</th>
            <th>Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range .Tasks}}
        <tr>
            <td><a href="/tasks/{{.Repo}}/{{.Slug}}">{{.Title}}</a></td>
            <td class="{{.Status}}">{{.Status}}</td>
            <td>
                {{if and $.IsOwner (eq .Status "open")}}
                <button class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="openStartDialog('start-{{.Slug}}')">Start</button>
                <dialog id="start-{{.Slug}}">
                    <article>
                        <header>
                            <button aria-label="Close" rel="prev" onclick="document.getElementById('start-{{.Slug}}').close()"></button>
                            <h3>Start: {{.Title}}</h3>
                        </header>
                        <form class="start-form" method="POST" action="/tasks/{{.Repo}}/{{.Slug}}/start" onsubmit="saveStartPrefs(this); this.querySelector('button[type=submit]').setAttribute('aria-busy', 'true'); this.querySelector('button[type=submit]').textContent = 'Starting...';">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <fieldset>
                                <legend>Choose Agent</legend>
                                <label><input type="radio" name="agent" value="claude"> Claude</label>
                                <label><input type="radio" name="agent" value="codex"> Codex</label>
                            </fieldset>
                            <fieldset>
                                <legend>Environment</legend>
                                <label><input type="radio" name="backend" value="local"> Local</label>
                                <label><input type="radio" name="backend" value="docker"> Docker</label>
                            </fieldset>
                            <label>
                                Dotfiles (optional)
                                <select name="dotfiles">
                                    {{if $.Dotfiles}}
                                    {{range $.Dotfiles}}
                                    <option value="{{.URL}}">{{.Name}}</option>
                                    {{end}}
                                    <option value="">-- None --</option>
                                    {{else}}
                                    <option value="">-- None --</option>
                                    {{end}}
                                </select>
                                <small><a href="/settings/dotfiles">Manage dotfiles</a></small>
                            </label>
                            <button type="submit">Start with Agent</button>
                        </form>
                    </article>
                </dialog>
                {{end}}
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{else}}
<p style="color: var(--pico-muted-color);">No tasks yet. Create one to get started.</p>
{{end}}
</section>

<section>
<h2>Branches</h2>
{{if .Branches}}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Task</th>
        </tr>
    </thead>
    <tbody>
        {{range .Branches}}
        <tr>
            <td><a href="/branches/{{.Repo}}/{{.Name}}">{{.Name}}</a></td>
            <td class="{{.Status}}">{{.Status}}</td>
            <td>{{if .TaskSlug}}<a href="/tasks/{{.TaskRepo}}/{{.TaskSlug}}">{{.TaskSlug}}</a>{{end}}</td>
        </tr>
        {{end}}
    </tbody>
</table>
{{else}}
<p style="color: var(--pico-muted-color);">No branches yet.</p>
{{end}}
</section>

<section>
<h2>Commits</h2>
{{if .Commits}}
<table>
    <thead>
        <tr>
            <th style="width: 80px;">Hash</th>
            <th>Message</th>
            <th style="width: 120px;">Author</th>
            <th style="width: 100px;">Date</th>
        </tr>
    </thead>
    <tbody>
        {{range .Commits}}
        <tr>
            <td><code>{{.Short}}</code></td>
            <td>{{.Subject}}</td>
            <td>{{.Author}}</td>
            <td style="color: var(--pico-muted-color);">{{.Date}}</td>
        </tr>
        {{end}}
    </tbody>
</table>
{{else}}
<p style="color: var(--pico-muted-color);">No commits yet.</p>
{{end}}
</section>

<script>
function saveStartPrefs(form) {
    localStorage.setItem('startPrefs', JSON.stringify({
        agent: form.agent.value,
        backend: form.backend.value,
        dotfiles: form.dotfiles.value
    }));
}
function loadStartPrefs(form) {
    const prefs = JSON.parse(localStorage.getItem('startPrefs') || '{}');
    if (prefs.agent) {
        const r = form.querySelector(`input[name=agent][value="${prefs.agent}"]`);
        if (r) r.checked = true;
    } else {
        form.querySelector('input[name=agent][value=claude]').checked = true;
    }
    if (prefs.backend) {
        const r = form.querySelector(`input[name=backend][value="${prefs.backend}"]`);
        if (r) r.checked = true;
    } else {
        form.querySelector('input[name=backend][value=local]').checked = true;
    }
    if (prefs.dotfiles) {
        const opt = form.querySelector(`select[name=dotfiles] option[value="${prefs.dotfiles}"]`);
        if (opt) opt.selected = true;
    }
}
function openStartDialog(id) {
    const dialog = document.getElementById(id);
    loadStartPrefs(dialog.querySelector('form'));
    dialog.showModal();
}
</script>
{{end}}
