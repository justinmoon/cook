{{template "base" .}}

{{define "content"}}
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>{{.Task.Title}}</h1>
    {{if .IsOwner}}
    <div style="display: flex; gap: 0.5rem;">
        <button class="outline" onclick="document.getElementById('edit-task').showModal()">Edit</button>
        <button class="outline secondary" onclick="document.getElementById('delete-task').showModal()">Delete</button>
    </div>
    {{end}}
</div>

{{if .IsOwner}}
<dialog id="edit-task">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('edit-task').close()"></button>
            <h3>Edit Task</h3>
        </header>
        <form method="POST" action="/tasks/{{.Task.Repo}}/{{.Task.Slug}}/edit">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <label>
                Title
                <input type="text" name="title" value="{{.Task.Title}}" required>
            </label>
            <label>
                Description
                <textarea name="body" rows="4">{{.Task.Body}}</textarea>
            </label>
            <label>
                Priority
                <select name="priority">
                    <option value="0" {{if eq .Task.Priority 0}}selected{{end}}>P0 - Critical</option>
                    <option value="1" {{if eq .Task.Priority 1}}selected{{end}}>P1 - High</option>
                    <option value="2" {{if eq .Task.Priority 2}}selected{{end}}>P2 - Medium</option>
                    <option value="3" {{if eq .Task.Priority 3}}selected{{end}}>P3 - Low</option>
                </select>
            </label>
            <label>
                Status
                <select name="status">
                    <option value="open" {{if eq .Task.Status "open"}}selected{{end}}>Open</option>
                    <option value="in_progress" {{if eq .Task.Status "in_progress"}}selected{{end}}>In Progress</option>
                    <option value="closed" {{if eq .Task.Status "closed"}}selected{{end}}>Closed</option>
                    <option value="abandoned" {{if eq .Task.Status "abandoned"}}selected{{end}}>Abandoned</option>
                </select>
            </label>
            <button type="submit">Save Changes</button>
        </form>
    </article>
</dialog>

<dialog id="delete-task">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('delete-task').close()"></button>
            <h3>Delete Task</h3>
        </header>
        <p>Are you sure you want to delete this task? This cannot be undone.</p>
        <form method="POST" action="/tasks/{{.Task.Repo}}/{{.Task.Slug}}/delete">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="secondary" onclick="document.getElementById('delete-task').close()">Cancel</button>
                <button type="submit" class="contrast">Delete Task</button>
            </div>
        </form>
    </article>
</dialog>
{{end}}

{{if .LinkedBranch}}
<div style="display: flex; gap: 1rem; align-items: center;">
    <a href="/branches/{{.LinkedBranch.Repo}}/{{.LinkedBranch.Name}}" role="button">Go to Branch: {{.LinkedBranch.Name}}</a>
    {{if $.IsOwner}}
    <form method="POST" action="/branches/{{.LinkedBranch.Repo}}/{{.LinkedBranch.Name}}/abandon" style="margin: 0;">
        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
        <button type="submit" class="secondary outline" style="padding: 0.5rem 1rem;">Delete Branch</button>
    </form>
    {{end}}
</div>
{{else if and .IsOwner (eq .Task.Status "open")}}
<button onclick="document.getElementById('start-task').showModal()">Start with Agent</button>
<dialog id="start-task">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('start-task').close()"></button>
            <h3>Start: {{.Task.Title}}</h3>
        </header>
        <form id="start-task-form" method="POST" action="/tasks/{{.Task.Repo}}/{{.Task.Slug}}/start" onsubmit="saveStartPrefs(this); this.querySelector('button[type=submit]').setAttribute('aria-busy', 'true'); this.querySelector('button[type=submit]').textContent = 'Starting...';">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <fieldset>
                <legend>Choose Agent</legend>
                <label><input type="radio" name="agent" value="claude"> Claude</label>
                <label><input type="radio" name="agent" value="codex"> Codex</label>
            </fieldset>
            <fieldset>
                <legend>Environment</legend>
                <label><input type="radio" name="backend" value="local"> Local</label>
                <label><input type="radio" name="backend" value="docker"> Docker</label>
            </fieldset>
            <label>
                Dotfiles (optional)
                <select name="dotfiles">
                    {{if .Dotfiles}}
                    {{range .Dotfiles}}
                    <option value="{{.URL}}">{{.Name}}</option>
                    {{end}}
                    <option value="">-- None --</option>
                    {{else}}
                    <option value="">-- None --</option>
                    {{end}}
                </select>
                <small><a href="/settings/dotfiles">Manage dotfiles</a></small>
            </label>
            <button type="submit">Start with Agent</button>
        </form>
        <script>
        function saveStartPrefs(form) {
            localStorage.setItem('startPrefs', JSON.stringify({
                agent: form.agent.value,
                backend: form.backend.value,
                dotfiles: form.dotfiles.value
            }));
        }
        function loadStartPrefs(form) {
            const prefs = JSON.parse(localStorage.getItem('startPrefs') || '{}');
            if (prefs.agent) {
                const r = form.querySelector(`input[name=agent][value="${prefs.agent}"]`);
                if (r) r.checked = true;
            } else {
                form.querySelector('input[name=agent][value=claude]').checked = true;
            }
            if (prefs.backend) {
                const r = form.querySelector(`input[name=backend][value="${prefs.backend}"]`);
                if (r) r.checked = true;
            } else {
                form.querySelector('input[name=backend][value=local]').checked = true;
            }
            if (prefs.dotfiles) {
                const opt = form.querySelector(`select[name=dotfiles] option[value="${prefs.dotfiles}"]`);
                if (opt) opt.selected = true;
            }
        }
        loadStartPrefs(document.getElementById('start-task-form'));
        </script>
    </article>
</dialog>
{{end}}

<dl>
    <dt>Slug</dt>
    <dd><code>{{.Task.Slug}}</code></dd>
    
    <dt>Repository</dt>
    <dd><a href="/repos/{{.Task.Repo}}">{{.Task.Repo}}</a></dd>
    
    <dt>Priority</dt>
    <dd>P{{.Task.Priority}}</dd>
    
    <dt>Status</dt>
    <dd class="{{.Task.Status}}">{{.Task.Status}}</dd>
    
    {{if .Task.Body}}
    <dt>Description</dt>
    <dd>{{.Task.Body}}</dd>
    {{end}}
    
    <dt>Created</dt>
    <dd>{{.Task.CreatedAt.Format "2006-01-02 15:04:05"}}</dd>
</dl>

{{if .Task.DependsOn}}
<h2>Dependencies</h2>
<ul>
    {{range .Task.DependsOn}}
    <li>{{.}}</li>
    {{end}}
</ul>
{{end}}
{{end}}
